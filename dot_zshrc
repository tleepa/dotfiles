# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

export ZSH="$HOME/.oh-my-zsh"
export ZSH_COMPDUMP="$HOME/.cache/zsh/.zcompdump-${SHORT_HOST}-${ZSH_VERSION}"

ZSH_THEME=powerlevel10k/powerlevel10k
DISABLE_AUTO_UPDATE="true"
COMPLETION_WAITING_DOTS="true"

plugins=(sudo)
command -v zoxide &>/dev/null && plugins+=('zoxide')
command -v fzf &>/dev/null && plugins+=('fzf')
command -v git &>/dev/null && plugins+=('git')
[ -d "$ZSH/custom/plugins/zsh-autosuggestions" ] && plugins+=('zsh-autosuggestions')
[ -d "$ZSH/custom/plugins/zsh-syntax-highlighting" ] && plugins+=('zsh-syntax-highlighting')
source $ZSH/oh-my-zsh.sh

# User configuration
export LANGUAGE=en_US.UTF-8
export LANG=en_US.UTF-8

setopt inc_append_history
setopt share_history
setopt hist_ignore_all_dups
setopt hist_save_no_dups
setopt hist_ignore_space
setopt extended_glob

[ -f ~/.p10k.zsh ] && source ~/.p10k.zsh

export SHELL=/bin/zsh
export EDITOR=vim
export PAGER=less
export ZLE_REMOVE_SUFFIX_CHARS=$' \t\n;'

export MANPAGER="/usr/bin/less -s -M +Gg"
export MANROFFOPT=-c
export LESS_TERMCAP_mb=$'\e[1;31m'      # begin bold
export LESS_TERMCAP_md=$'\e[1;34m'      # begin blink
export LESS_TERMCAP_so=$'\e[01;45;37m'  # begin reverse video
export LESS_TERMCAP_us=$'\e[01;36m'     # begin underline
export LESS_TERMCAP_me=$'\e[0m'         # reset bold/blink
export LESS_TERMCAP_se=$'\e[0m'         # reset reverse video
export LESS_TERMCAP_ue=$'\e[0m'         # reset underline

export FZF_DEFAULT_OPTS='--color=fg:#f8f8f2,bg:#282a36,hl:#bd93f9 --color=fg+:#f8f8f2,bg+:#44475a,hl+:#bd93f9 --color=info:#ffb86c,prompt:#50fa7b,pointer:#ff79c6 --color=marker:#ff79c6,spinner:#ffb86c,header:#6272a4'
export DBX_CONTAINER_NAME=fedora-toolbox-39
# export DISPLAY=127.0.0.1:0

# homebrew
[ -d /opt/homebrew ] && BREW_CMD=/opt/homebrew/bin/brew
[ -d /home/linuxbrew ] && BREW_CMD=/home/linuxbrew/.linuxbrew/bin/brew
if command -v "$BREW_CMD" &>/dev/null; then
  export HOMEBREW_BAT=1
  export HOMEBREW_NO_EMOJI=1
  export HOMEBREW_NO_ENV_HINTS=1
  export HOMEBREW_FORCE_VENDOR_RUBY=1

  eval "$($(command -v "$BREW_CMD") shellenv)"
  fpath=(${HOMEBREW_PREFIX}/share/zsh/site-functions $fpath)
fi

command -v mise &>/dev/null && export MISE_DEFAULT_CONFIG_FILENAME=mise.local.toml && eval "$(mise activate zsh)"
command -v terraform &>/dev/null && export TF_CLI_CONFIG_FILE="$HOME/.config/.terraformrc"

# docker
command -v systemctl &>/dev/null && systemctl status systemd-logind &>/dev/null && [ ! "$CONTAINER_ID" ] && systemctl --user is-active podman.socket &>/dev/null && export DOCKER_HOST=unix://$XDG_RUNTIME_DIR/podman/podman.sock

# WSL SSH agent
[ "$WSL_DISTRO_NAME" ] && command -v wsl-ssh-agent-relay &>/dev/null && wsl-ssh-agent-relay start
[ "$WSL_DISTRO_NAME" ] && [ -f "$HOME/.wsl-ssh-agent-relay.pid" ] && export SSH_AUTH_SOCK="$HOME/.wsl-ssh-agent.sock"

# Secrets
[ -f "$HOME/.config/ansible.cfg" ] &>/dev/null && export ANSIBLE_CONFIG="$HOME/.config/ansible.cfg"
[ -f "$HOME/.config/.ansible-vault-pwd" ] &>/dev/null && export ANSIBLE_VAULT_PASSWORD_FILE="$HOME/.config/.ansible-vault-pwd"
[ -f "$HOME/.config/.github-token" ] && command -v git &>/dev/null && source "$HOME/.config/.github-token"

# Completions
autoload -Uz +X compinit && compinit
autoload -Uz +X bashcompinit && bashcompinit

[ ! "$CONTAINER_ID" ] && command -v pipx &>/dev/null && command -v register-python-argcomplete &>/dev/null && eval "$(register-python-argcomplete pipx)"
command -v zoxide &>/dev/null && eval "$(zoxide init zsh)"
command -v update-tools.py &>/dev/null && complete -C "update-tools.py -l | tail -n +2" update-tools.py
[ -f /usr/share/google-cloud-sdk/completion.zsh.inc ] && source /usr/share/google-cloud-sdk/completion.zsh.inc

# Aliases
[ -f "$HOME/.config/aliasrc" ] && source "$HOME/.config/aliasrc"

# Powershell telemetry and updates
if command -v pwsh &>/dev/null; then
  export COMPlus_EnableDiagnostics=0

  export DOTNET_CLI_TELEMETRY_OPTOUT=1
  export DOTNET_TELEMETRY_OPTOUT=1

  export POWERSHELL_CLI_TELEMETRY_OPTOUT=1
  export POWERSHELL_TELEMETRY_OPTOUT=1
  export POWERSHELL_UPDATECHECK=Off
  export POWERSHELL_UPDATECHECK_OPTOUT=1
fi

# DotNet
if [ -d "$HOME/.dotnet" ]; then
  export DOTNET_ROOT=$HOME/.dotnet
  export PATH=$PATH:$DOTNET_ROOT:$DOTNET_ROOT/tools
fi
